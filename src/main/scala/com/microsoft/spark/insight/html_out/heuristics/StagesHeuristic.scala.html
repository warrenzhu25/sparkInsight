<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>heuristics/StagesHeuristic.scala - Spark Insight</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}


  </style>
 </head>
 <body>

  <h1>heuristics/StagesHeuristic.scala - Spark Insight</h1>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L34">StagesEvaluator</a></li>
<li><a href="#L30">StagesHeuristic</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L95">formatStageWithHighTaskFailureRate</a></li>
<li><a href="#L88">formatStageWithLongRuntime</a></li>
<li><a href="#L91">formatStagesWithHighTaskFailureRates</a></li>
</ul>
 <h2>Source code</h2>

  <code>/*<br/>
 * Copyright 2016 LinkedIn Corp.<br/>
 *<br/>
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not<br/>
 * use this file except in compliance with the License. You may obtain a copy of<br/>
 * the License at<br/>
 *<br/>
 * http://www.apache.org/licenses/LICENSE-2.0<br/>
 *<br/>
 * Unless required by applicable law or agreed to in writing, software<br/>
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT<br/>
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the<br/>
 * License for the specific language governing permissions and limitations under<br/>
 * the License.<br/>
 */<br/>
<br/>
package com.microsoft.spark.insight.heuristics<br/>
<br/>
<br/>
import com.microsoft.spark.insight.fetcher.<a href="../fetcher/SparkApplicationData.scala.html#L21" title="fetcher/SparkApplicationData.scala:21">SparkApplicationData</a><br/>
import com.microsoft.spark.insight.fetcher.<a href="../fetcher/status/statusapiv1.scala.html#L111" title="fetcher/status/statusapiv1.scala:111">status</a>.{<a href="../fetcher/status/statusapiv1.scala.html#L148" title="fetcher/status/statusapiv1.scala:148">StageData</a>, StageStatus}<br/>
import com.microsoft.spark.insight.math.Statistics<br/>
<br/>
/**<br/>
 * A heuristic based on metrics for a Spark app's stages.<br/>
 *<br/>
 * This heuristic reports <a href="../utils/spark/PerStageReport.scala.html#L26" title="utils/spark/PerStageReport.scala:26">stage</a> failures, high task <a href="../utils/spark/PerJobReport.scala.html#L33" title="utils/spark/PerJobReport.scala:33">failure</a> rates for each <a href="../utils/spark/PerStageReport.scala.html#L26" title="utils/spark/PerStageReport.scala:26">stage</a>,<br/>
 * and long average executor runtimes for each <a href="../utils/spark/PerStageReport.scala.html#L26" title="utils/spark/PerStageReport.scala:26">stage</a>.<br/>
 */<br/>
<a id="L30">&#x200c;</a>object <span class="linkable">StagesHeuristic</span> extends <a href="Heuristic.scala.html#L19" title="heuristics/Heuristic.scala:19">Heuristic</a> {<br/>
<br/>
&nbsp; override val evaluators = Seq(<a href="#L34" title="heuristics/StagesHeuristic.scala:34">StagesEvaluator</a>)<br/>
<br/>
<a id="L34">&#x200c;</a>&nbsp; object <span class="linkable">StagesEvaluator</span> extends <a href="SparkEvaluator.scala.html#L22" title="heuristics/SparkEvaluator.scala:22">SparkEvaluator</a> {<br/>
<br/>
&nbsp; &nbsp; override def <a href="ConfigurationHeuristic.scala.html#L47" title="heuristics/ConfigurationHeuristic.scala:47">evaluate</a>(sparkAppData: <a href="../fetcher/SparkApplicationData.scala.html#L21" title="fetcher/SparkApplicationData.scala:21">SparkApplicationData</a>): Seq[<a href="HeuristicResult.scala.html#L18" title="heuristics/HeuristicResult.scala:18">AnalysisResult</a>] = {<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val stageDatas: Seq[<a href="../fetcher/status/statusapiv1.scala.html#L148" title="fetcher/status/statusapiv1.scala:148">StageData</a>] = sparkAppData.stageData<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val <a href="../fetcher/status/statusapiv1.scala.html#L118" title="fetcher/status/statusapiv1.scala:118">numCompletedStages</a>: Int = stageDatas.count {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; _.<a href="../fetcher/status/statusapiv1.scala.html#L111" title="fetcher/status/statusapiv1.scala:111">status</a> == StageStatus.COMPLETE<br/>
&nbsp; &nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val <a href="../fetcher/status/statusapiv1.scala.html#L120" title="fetcher/status/statusapiv1.scala:120">numFailedStages</a>: Int = stageDatas.count {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; _.<a href="../fetcher/status/statusapiv1.scala.html#L111" title="fetcher/status/statusapiv1.scala:111">status</a> == StageStatus.FAILED<br/>
&nbsp; &nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val stageFailureRate: Option[Double] = {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; val numStages = <a href="../fetcher/status/statusapiv1.scala.html#L118" title="fetcher/status/statusapiv1.scala:118">numCompletedStages</a> + <a href="../fetcher/status/statusapiv1.scala.html#L120" title="fetcher/status/statusapiv1.scala:120">numFailedStages</a><br/>
&nbsp; &nbsp; &nbsp; &nbsp; if (numStages == 0) None else Some(<a href="../fetcher/status/statusapiv1.scala.html#L120" title="fetcher/status/statusapiv1.scala:120">numFailedStages</a>.toDouble / numStages.toDouble)<br/>
&nbsp; &nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; &nbsp; val stageAnalysis = new <a href="StageAnalyzer.scala.html#L125" title="heuristics/StageAnalyzer.scala:125">StagesAnalyzer</a>(sparkAppData).<a href="StageAnalyzer.scala.html#L183" title="heuristics/StageAnalyzer.scala:183">getStageAnalysis</a>()<br/>
<br/>
&nbsp; &nbsp; &nbsp; val summaryRows = Seq(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a href="HeuristicResult.scala.html#L68" title="heuristics/HeuristicResult.scala:68">SimpleRowResult</a>(&quot;Spark <a href="../fetcher/status/statusapiv1.scala.html#L63" title="fetcher/status/statusapiv1.scala:63">completed</a> stages count&quot;, <a href="../fetcher/status/statusapiv1.scala.html#L118" title="fetcher/status/statusapiv1.scala:118">numCompletedStages</a>.toString),<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a href="HeuristicResult.scala.html#L68" title="heuristics/HeuristicResult.scala:68">SimpleRowResult</a>(&quot;Spark failed stages count&quot;, <a href="../fetcher/status/statusapiv1.scala.html#L120" title="fetcher/status/statusapiv1.scala:120">numFailedStages</a>.toString),<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a href="HeuristicResult.scala.html#L68" title="heuristics/HeuristicResult.scala:68">SimpleRowResult</a>(&quot;Spark <a href="../utils/spark/PerStageReport.scala.html#L26" title="utils/spark/PerStageReport.scala:26">stage</a> <a href="../utils/spark/PerJobReport.scala.html#L33" title="utils/spark/PerJobReport.scala:33">failure</a> rate&quot;, f&quot;${stageFailureRate.getOrElse(0.0D)}%.3f&quot;)<br/>
&nbsp; &nbsp; &nbsp; )<br/>
<br/>
&nbsp; &nbsp; &nbsp; stageAnalysis.flatMap(_.stageAnalysisResults)<br/>
<br/>
&nbsp; &nbsp; &nbsp; /*<br/>
&nbsp; &nbsp; &nbsp; Seq(<br/>
&nbsp; &nbsp; &nbsp; MultipleValuesResult(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;Spark stages with long average executor runtimes&quot;,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; formatStagesWithLongAverageExecutorRuntimes(stagesWithLongAverageExecutorRuntimes)<br/>
&nbsp; &nbsp; &nbsp; ),<br/>
&nbsp; &nbsp; &nbsp; MultipleValuesResult(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;Spark task <a href="../utils/spark/PerJobReport.scala.html#L33" title="utils/spark/PerJobReport.scala:33">failure</a> result&quot;, stageAnalysis.map(_.taskFailureResult.toString)<br/>
&nbsp; &nbsp; &nbsp; ),<br/>
&nbsp; &nbsp; &nbsp; MultipleValuesResult(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;Spark <a href="../utils/spark/PerStageReport.scala.html#L26" title="utils/spark/PerStageReport.scala:26">stage</a> <a href="../utils/spark/PerJobReport.scala.html#L33" title="utils/spark/PerJobReport.scala:33">failure</a> result&quot;, stageAnalysis.flatMap(_.stageFailureResult.<a href="../fetcher/status/statusapiv1.scala.html#L176" title="fetcher/status/statusapiv1.scala:176">details</a>)<br/>
&nbsp; &nbsp; &nbsp; ),<br/>
&nbsp; &nbsp; &nbsp; MultipleValuesResult(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;Spark task skew result&quot;, stageAnalysis.flatMap(_.taskSkewResult.<a href="../fetcher/status/statusapiv1.scala.html#L176" title="fetcher/status/statusapiv1.scala:176">details</a>)<br/>
&nbsp; &nbsp; &nbsp; ),<br/>
&nbsp; &nbsp; &nbsp; MultipleValuesResult(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;Spark long task result&quot;, stageAnalysis.flatMap(_.longTaskResult.<a href="../fetcher/status/statusapiv1.scala.html#L176" title="fetcher/status/statusapiv1.scala:176">details</a>)<br/>
&nbsp; &nbsp; &nbsp; ),<br/>
&nbsp; &nbsp; &nbsp; MultipleValuesResult(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;Spark task spill result&quot;, stageAnalysis.flatMap(_.executionMemorySpillResult.<a href="../fetcher/status/statusapiv1.scala.html#L176" title="fetcher/status/statusapiv1.scala:176">details</a>)<br/>
&nbsp; &nbsp; &nbsp; )<br/>
&nbsp; &nbsp; &nbsp; )<br/>
&nbsp; &nbsp; &nbsp; */<br/>
&nbsp; &nbsp; }<br/>
<br/>
<a id="L88">&#x200c;</a>&nbsp; &nbsp; def <span class="linkable">formatStageWithLongRuntime</span>(stageData: <a href="../fetcher/status/statusapiv1.scala.html#L148" title="fetcher/status/statusapiv1.scala:148">StageData</a>, runtime: Long): String =<br/>
&nbsp; &nbsp; &nbsp; f&quot;<a href="../utils/spark/PerStageReport.scala.html#L26" title="utils/spark/PerStageReport.scala:26">stage</a> ${stageData.<a href="../fetcher/status/statusapiv1.scala.html#L150" title="fetcher/status/statusapiv1.scala:150">stageId</a>}, <a href="../fetcher/status/statusapiv1.scala.html#L193" title="fetcher/status/statusapiv1.scala:193">attempt</a> ${stageData.<a href="../fetcher/status/statusapiv1.scala.html#L59" title="fetcher/status/statusapiv1.scala:59">attemptId</a>} (runtime: ${Statistics.readableTimespan(runtime)})&quot;<br/>
<br/>
<a id="L91">&#x200c;</a>&nbsp; &nbsp; def <span class="linkable">formatStagesWithHighTaskFailureRates</span>(stagesWithHighTaskFailureRates: Seq[(<a href="../fetcher/status/statusapiv1.scala.html#L148" title="fetcher/status/statusapiv1.scala:148">StageData</a>, Double)]): Seq[String] =<br/>
&nbsp; &nbsp; &nbsp; stagesWithHighTaskFailureRates<br/>
&nbsp; &nbsp; &nbsp; &nbsp; .map { case (stageData, taskFailureRate) =&gt; <a href="#L95" title="heuristics/StagesHeuristic.scala:95">formatStageWithHighTaskFailureRate</a>(stageData, taskFailureRate) }<br/>
<br/>
<a id="L95">&#x200c;</a>&nbsp; &nbsp; def <span class="linkable">formatStageWithHighTaskFailureRate</span>(stageData: <a href="../fetcher/status/statusapiv1.scala.html#L148" title="fetcher/status/statusapiv1.scala:148">StageData</a>, taskFailureRate: Double): String =<br/>
&nbsp; &nbsp; &nbsp; f&quot;<a href="../utils/spark/PerStageReport.scala.html#L26" title="utils/spark/PerStageReport.scala:26">stage</a> ${stageData.<a href="../fetcher/status/statusapiv1.scala.html#L150" title="fetcher/status/statusapiv1.scala:150">stageId</a>}, <a href="../fetcher/status/statusapiv1.scala.html#L193" title="fetcher/status/statusapiv1.scala:193">attempt</a> ${stageData.<a href="../fetcher/status/statusapiv1.scala.html#L59" title="fetcher/status/statusapiv1.scala:59">attemptId</a>} (task <a href="../utils/spark/PerJobReport.scala.html#L33" title="utils/spark/PerJobReport.scala:33">failure</a> rate: ${taskFailureRate}%1.3f)&quot;<br/>
<br/>
&nbsp; }<br/>
<br/>
}<br/>
</code>

 </body>
</html>
