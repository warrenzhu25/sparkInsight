<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>heuristics/JobsHeuristic.scala - Spark Insight</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}


  </style>
 </head>
 <body>

  <h1>heuristics/JobsHeuristic.scala - Spark Insight</h1>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L42">JobEvaluator</a></li>
<li><a href="#L28">JobsHeuristic</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L44">evaluate</a></li>
<li><a href="#L85">formatFailedJob</a></li>
<li><a href="#L91">formatJobWithHighTaskFailureRate</a></li>
<li><a href="#L87">formatJobsWithHighTaskFailureRates</a></li>
<li><a href="#L94">taskFailureRateAndSeverityOf</a></li>
<li><a href="#L99">taskFailureRateOf</a></li>
</ul>
 <h2>Source code</h2>

  <code>/*<br/>
 * Copyright 2016 LinkedIn Corp.<br/>
 *<br/>
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not<br/>
 * use this file except in compliance with the License. You may obtain a copy of<br/>
 * the License at<br/>
 *<br/>
 * http://www.apache.org/licenses/LICENSE-2.0<br/>
 *<br/>
 * Unless required by applicable law or agreed to in writing, software<br/>
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT<br/>
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the<br/>
 * License for the specific language governing permissions and limitations under<br/>
 * the License.<br/>
 */<br/>
<br/>
package com.microsoft.spark.insight.heuristics<br/>
<br/>
import com.microsoft.spark.insight.fetcher.<a href="../fetcher/SparkApplicationData.scala.html#L21" title="fetcher/SparkApplicationData.scala:21">SparkApplicationData</a><br/>
import com.microsoft.spark.insight.fetcher.<a href="../fetcher/status/statusapiv1.scala.html#L111" title="fetcher/status/statusapiv1.scala:111">status</a>.<a href="../fetcher/status/statusapiv1.scala.html#L103" title="fetcher/status/statusapiv1.scala:103">JobData</a><br/>
import org.apache.spark.JobExecutionStatus<br/>
<br/>
/**<br/>
 * A heuristic based on metrics for a Spark app's jobs.<br/>
 *<br/>
 * This heuristic reports <a href="../utils/spark/PerJobReport.scala.html#L48" title="utils/spark/PerJobReport.scala:48">job</a> failures and high task <a href="../utils/spark/PerJobReport.scala.html#L33" title="utils/spark/PerJobReport.scala:33">failure</a> rates for each <a href="../utils/spark/PerJobReport.scala.html#L48" title="utils/spark/PerJobReport.scala:48">job</a>.<br/>
 */<br/>
<a id="L28">&#x200c;</a>object <span class="linkable">JobsHeuristic</span> extends <a href="Heuristic.scala.html#L19" title="heuristics/Heuristic.scala:19">Heuristic</a> {<br/>
&nbsp; override val evaluators = Seq(<a href="#L42" title="heuristics/JobsHeuristic.scala:42">JobEvaluator</a>)<br/>
&nbsp; /** The default severity thresholds for the rate of an application's jobs failing. */<br/>
&nbsp; val DEFAULT_JOB_FAILURE_RATE_SEVERITY_THRESHOLDS =<br/>
&nbsp; &nbsp; <a href="SeverityThresholds.scala.html#L22" title="heuristics/SeverityThresholds.scala:22">SeverityThresholds</a>(low = 0.1D, moderate = 0.3D, severe = 0.5D, critical = 0.5D, ascending = true)<br/>
&nbsp; /** The default severity thresholds for the rate of a <a href="../utils/spark/PerJobReport.scala.html#L48" title="utils/spark/PerJobReport.scala:48">job</a>'s <a href="../fetcher/status/statusapiv1.scala.html#L180" title="fetcher/status/statusapiv1.scala:180">tasks</a> failing. */<br/>
&nbsp; val DEFAULT_TASK_FAILURE_RATE_SEVERITY_THRESHOLDS =<br/>
&nbsp; &nbsp; <a href="SeverityThresholds.scala.html#L22" title="heuristics/SeverityThresholds.scala:22">SeverityThresholds</a>(low = 0.1D, moderate = 0.3D, severe = 0.5D, critical = 0.5D, ascending = true)<br/>
&nbsp; val JOB_FAILURE_RATE_SEVERITY_THRESHOLDS_KEY = &quot;job_failure_rate_severity_thresholds&quot;<br/>
&nbsp; val TASK_FAILURE_RATE_SEVERITY_THRESHOLDS_KEY = &quot;job_task_failure_rate_severity_thresholds&quot;<br/>
&nbsp; val jobFailureRateSeverityThresholds: <a href="SeverityThresholds.scala.html#L22" title="heuristics/SeverityThresholds.scala:22">SeverityThresholds</a> =<br/>
&nbsp; &nbsp; DEFAULT_JOB_FAILURE_RATE_SEVERITY_THRESHOLDS<br/>
&nbsp; val taskFailureRateSeverityThresholds = DEFAULT_TASK_FAILURE_RATE_SEVERITY_THRESHOLDS<br/>
<br/>
<a id="L42">&#x200c;</a>&nbsp; object <span class="linkable">JobEvaluator</span> extends <a href="SparkEvaluator.scala.html#L22" title="heuristics/SparkEvaluator.scala:22">SparkEvaluator</a> {<br/>
<br/>
<a id="L44">&#x200c;</a>&nbsp; &nbsp; def <span class="linkable">evaluate</span>(sparkAppData: <a href="../fetcher/SparkApplicationData.scala.html#L21" title="fetcher/SparkApplicationData.scala:21">SparkApplicationData</a>): Seq[<a href="HeuristicResult.scala.html#L18" title="heuristics/HeuristicResult.scala:18">AnalysisResult</a>] = {<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val jobDatas: Seq[<a href="../fetcher/status/statusapiv1.scala.html#L103" title="fetcher/status/statusapiv1.scala:103">JobData</a>] = sparkAppData.jobData<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val numCompletedJobs: Int = jobDatas.count {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; _.<a href="../fetcher/status/statusapiv1.scala.html#L111" title="fetcher/status/statusapiv1.scala:111">status</a> == JobExecutionStatus.SUCCEEDED<br/>
&nbsp; &nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val numFailedJobs: Int = jobDatas.count {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; _.<a href="../fetcher/status/statusapiv1.scala.html#L111" title="fetcher/status/statusapiv1.scala:111">status</a> == JobExecutionStatus.FAILED<br/>
&nbsp; &nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val failedJobs: Seq[<a href="../fetcher/status/statusapiv1.scala.html#L103" title="fetcher/status/statusapiv1.scala:103">JobData</a>] = jobDatas.filter {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; _.<a href="../fetcher/status/statusapiv1.scala.html#L111" title="fetcher/status/statusapiv1.scala:111">status</a> == JobExecutionStatus.FAILED<br/>
&nbsp; &nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val jobFailureRate: Option[Double] = {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; // Currently, the calculation assumes there are no jobs with UNKNOWN or RUNNING state.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; val numJobs = numCompletedJobs + numFailedJobs<br/>
&nbsp; &nbsp; &nbsp; &nbsp; if (numJobs == 0) None else Some(numFailedJobs.toDouble / numJobs.toDouble)<br/>
&nbsp; &nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val jobsWithHighTaskFailureRates: Seq[(<a href="../fetcher/status/statusapiv1.scala.html#L103" title="fetcher/status/statusapiv1.scala:103">JobData</a>, Double)] =<br/>
&nbsp; &nbsp; &nbsp; &nbsp; jobsWithHighTaskFailureRateSeverities.map { case (jobData, taskFailureRate, _) =&gt; (jobData, taskFailureRate) }<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val severity: Severity = Severity.<a href="../utils/AggregatePerfValue.scala.html#L26" title="utils/AggregatePerfValue.scala:26">max</a>((jobFailureRateSeverity +: taskFailureRateSeverities): _*)<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val jobFailureRateSeverity: Severity =<br/>
&nbsp; &nbsp; &nbsp; &nbsp; jobFailureRateSeverityThresholds.<a href="SeverityThresholds.scala.html#L33" title="heuristics/SeverityThresholds.scala:33">severityOf</a>(jobFailureRate.getOrElse[Double](0.0D))<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val jobsWithHighTaskFailureRateSeverities: Seq[(<a href="../fetcher/status/statusapiv1.scala.html#L103" title="fetcher/status/statusapiv1.scala:103">JobData</a>, Double, Severity)] =<br/>
&nbsp; &nbsp; &nbsp; &nbsp; jobsAndTaskFailureRateSeverities.filter { case (_, _, severity) =&gt; severity.<a href="../utils/spark/SparkMetricsRowConversionUtils.scala.html#L242" title="utils/spark/SparkMetricsRowConversionUtils.scala:242">getValue</a> &gt; Severity.MODERATE.<a href="../utils/spark/SparkMetricsRowConversionUtils.scala.html#L242" title="utils/spark/SparkMetricsRowConversionUtils.scala:242">getValue</a> }<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val jobsAndTaskFailureRateSeverities: Seq[(<a href="../fetcher/status/statusapiv1.scala.html#L103" title="fetcher/status/statusapiv1.scala:103">JobData</a>, Double, Severity)] = for {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; jobData &lt;- jobDatas<br/>
&nbsp; &nbsp; &nbsp; &nbsp; (taskFailureRate, severity) = <a href="#L94" title="heuristics/JobsHeuristic.scala:94">taskFailureRateAndSeverityOf</a>(jobData)<br/>
&nbsp; &nbsp; &nbsp; } yield (jobData, taskFailureRate, severity)<br/>
<br/>
&nbsp; &nbsp; &nbsp; lazy val taskFailureRateSeverities: Seq[Severity] =<br/>
&nbsp; &nbsp; &nbsp; &nbsp; jobsAndTaskFailureRateSeverities.map { case (_, _, severity) =&gt; severity }<br/>
<br/>
<a id="L85">&#x200c;</a>&nbsp; &nbsp; &nbsp; def <span class="linkable">formatFailedJob</span>(jobData: <a href="../fetcher/status/statusapiv1.scala.html#L103" title="fetcher/status/statusapiv1.scala:103">JobData</a>): String = f&quot;<a href="../utils/spark/PerJobReport.scala.html#L48" title="utils/spark/PerJobReport.scala:48">job</a> ${jobData.<a href="../fetcher/status/statusapiv1.scala.html#L104" title="fetcher/status/statusapiv1.scala:104">jobId</a>}, ${jobData.<a href="../fetcher/status/statusapiv1.scala.html#L48" title="fetcher/status/statusapiv1.scala:48">name</a>}&quot;<br/>
<br/>
<a id="L87">&#x200c;</a>&nbsp; &nbsp; &nbsp; def <span class="linkable">formatJobsWithHighTaskFailureRates</span>(jobsWithHighTaskFailureRates: Seq[(<a href="../fetcher/status/statusapiv1.scala.html#L103" title="fetcher/status/statusapiv1.scala:103">JobData</a>, Double)]): Seq[String] =<br/>
&nbsp; &nbsp; &nbsp; &nbsp; jobsWithHighTaskFailureRates<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .map { case (jobData, taskFailureRate) =&gt; <a href="#L91" title="heuristics/JobsHeuristic.scala:91">formatJobWithHighTaskFailureRate</a>(jobData, taskFailureRate) }<br/>
<br/>
<a id="L91">&#x200c;</a>&nbsp; &nbsp; &nbsp; def <span class="linkable">formatJobWithHighTaskFailureRate</span>(jobData: <a href="../fetcher/status/statusapiv1.scala.html#L103" title="fetcher/status/statusapiv1.scala:103">JobData</a>, taskFailureRate: Double): String =<br/>
&nbsp; &nbsp; &nbsp; &nbsp; f&quot;<a href="../utils/spark/PerJobReport.scala.html#L48" title="utils/spark/PerJobReport.scala:48">job</a> ${jobData.<a href="../fetcher/status/statusapiv1.scala.html#L104" title="fetcher/status/statusapiv1.scala:104">jobId</a>}, ${jobData.<a href="../fetcher/status/statusapiv1.scala.html#L48" title="fetcher/status/statusapiv1.scala:48">name</a>} (task <a href="../utils/spark/PerJobReport.scala.html#L33" title="utils/spark/PerJobReport.scala:33">failure</a> rate: ${taskFailureRate}%1.3f)&quot;<br/>
<br/>
<a id="L94">&#x200c;</a>&nbsp; &nbsp; &nbsp; def <span class="linkable">taskFailureRateAndSeverityOf</span>(jobData: <a href="../fetcher/status/statusapiv1.scala.html#L103" title="fetcher/status/statusapiv1.scala:103">JobData</a>): (Double, Severity) = {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; val taskFailureRate = <a href="#L99" title="heuristics/JobsHeuristic.scala:99">taskFailureRateOf</a>(jobData).getOrElse(0.0D)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; (taskFailureRate, taskFailureRateSeverityThresholds.<a href="SeverityThresholds.scala.html#L33" title="heuristics/SeverityThresholds.scala:33">severityOf</a>(taskFailureRate))<br/>
&nbsp; &nbsp; &nbsp; }<br/>
<br/>
<a id="L99">&#x200c;</a>&nbsp; &nbsp; &nbsp; def <span class="linkable">taskFailureRateOf</span>(jobData: <a href="../fetcher/status/statusapiv1.scala.html#L103" title="fetcher/status/statusapiv1.scala:103">JobData</a>): Option[Double] = {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; // Currently, the calculation doesn't include skipped or active <a href="../fetcher/status/statusapiv1.scala.html#L180" title="fetcher/status/statusapiv1.scala:180">tasks</a>.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; val <a href="../fetcher/status/statusapiv1.scala.html#L114" title="fetcher/status/statusapiv1.scala:114">numCompletedTasks</a> = jobData.<a href="../fetcher/status/statusapiv1.scala.html#L114" title="fetcher/status/statusapiv1.scala:114">numCompletedTasks</a><br/>
&nbsp; &nbsp; &nbsp; &nbsp; val <a href="../fetcher/status/statusapiv1.scala.html#L116" title="fetcher/status/statusapiv1.scala:116">numFailedTasks</a> = jobData.<a href="../fetcher/status/statusapiv1.scala.html#L116" title="fetcher/status/statusapiv1.scala:116">numFailedTasks</a><br/>
&nbsp; &nbsp; &nbsp; &nbsp; val <a href="../fetcher/status/statusapiv1.scala.html#L112" title="fetcher/status/statusapiv1.scala:112">numTasks</a> = <a href="../fetcher/status/statusapiv1.scala.html#L114" title="fetcher/status/statusapiv1.scala:114">numCompletedTasks</a> + <a href="../fetcher/status/statusapiv1.scala.html#L116" title="fetcher/status/statusapiv1.scala:116">numFailedTasks</a><br/>
&nbsp; &nbsp; &nbsp; &nbsp; if (<a href="../fetcher/status/statusapiv1.scala.html#L112" title="fetcher/status/statusapiv1.scala:112">numTasks</a> == 0) None else Some(<a href="../fetcher/status/statusapiv1.scala.html#L116" title="fetcher/status/statusapiv1.scala:116">numFailedTasks</a>.toDouble / <a href="../fetcher/status/statusapiv1.scala.html#L112" title="fetcher/status/statusapiv1.scala:112">numTasks</a>.toDouble)<br/>
&nbsp; &nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; &nbsp; val <a href="HeuristicResult.scala.html#L25" title="heuristics/HeuristicResult.scala:25">rows</a> = Seq(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a href="HeuristicResult.scala.html#L68" title="heuristics/HeuristicResult.scala:68">SimpleRowResult</a>(&quot;Spark <a href="../fetcher/status/statusapiv1.scala.html#L63" title="fetcher/status/statusapiv1.scala:63">completed</a> jobs count&quot;, numCompletedJobs.toString),<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a href="HeuristicResult.scala.html#L68" title="heuristics/HeuristicResult.scala:68">SimpleRowResult</a>(&quot;Spark failed jobs count&quot;, numFailedJobs.toString),<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a href="HeuristicResult.scala.html#L68" title="heuristics/HeuristicResult.scala:68">SimpleRowResult</a>(&quot;Spark failed jobs list&quot;, failedJobs.map(<a href="#L85" title="heuristics/JobsHeuristic.scala:85">formatFailedJob</a>).mkString(&quot;,&quot;)),<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a href="HeuristicResult.scala.html#L68" title="heuristics/HeuristicResult.scala:68">SimpleRowResult</a>(&quot;Spark <a href="../utils/spark/PerJobReport.scala.html#L48" title="utils/spark/PerJobReport.scala:48">job</a> <a href="../utils/spark/PerJobReport.scala.html#L33" title="utils/spark/PerJobReport.scala:33">failure</a> rate&quot;, f&quot;${jobFailureRate.getOrElse(0.0D)}%.3f&quot;),<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a href="HeuristicResult.scala.html#L68" title="heuristics/HeuristicResult.scala:68">SimpleRowResult</a>(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;Spark jobs with high task <a href="../utils/spark/PerJobReport.scala.html#L33" title="utils/spark/PerJobReport.scala:33">failure</a> rates&quot;,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L87" title="heuristics/JobsHeuristic.scala:87">formatJobsWithHighTaskFailureRates</a>(jobsWithHighTaskFailureRates).mkString(&quot;,&quot;)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ))<br/>
<br/>
&nbsp; &nbsp; &nbsp; Seq(<a href="HeuristicResult.scala.html#L56" title="heuristics/HeuristicResult.scala:56">SimpleResult</a>(&quot;Job Summary&quot;, <a href="HeuristicResult.scala.html#L25" title="heuristics/HeuristicResult.scala:25">rows</a>))<br/>
&nbsp; &nbsp; }<br/>
&nbsp; }<br/>
<br/>
}<br/>
</code>

 </body>
</html>
