<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/spark/SparkAppPerfRegressionReport.scala - Spark Insight</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}


  </style>
 </head>
 <body>

  <h1>utils/spark/SparkAppPerfRegressionReport.scala - Spark Insight</h1>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L23">SparkAppPerfRegressionReport</a></li>
<li><a href="#L48">SparkAppPerfRegressionReport</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L50">RegressionAnalysisPerfMetrics</a></li>
<li><a href="#L83">jobLevelRegressionAnalysis</a></li>
<li><a href="#L77">perJobRegressionAnalysis</a></li>
<li><a href="#L70">perStageRegressionAnalysis</a></li>
</ul>
 <h2>Source code</h2>

  <code>package com.microsoft.spark.insight.utils.spark<br/>
<br/>
import com.microsoft.spark.insight.utils._<br/>
import com.microsoft.spark.insight.utils.<a href="../RegressionAnalysis.scala.html#L18" title="utils/RegressionAnalysis.scala:18">RegressionAnalysis</a><br/>
import com.microsoft.spark.insight.utils.spark.<a href="#L23" title="utils/spark/SparkAppPerfRegressionReport.scala:23">SparkAppPerfRegressionReport</a>._<br/>
import com.microsoft.spark.insight.utils.spark.<a href="SparkAppReportMatcher.scala.html#L17" title="utils/spark/SparkAppReportMatcher.scala:17">SparkAppReportMatcher</a>.{<br/>
&nbsp; JobName,<br/>
&nbsp; <a href="SparkAppReportMatcher.scala.html#L113" title="utils/spark/SparkAppReportMatcher.scala:113">MatchingJobMetrics</a>,<br/>
&nbsp; <a href="SparkAppReportMatcher.scala.html#L53" title="utils/spark/SparkAppReportMatcher.scala:53">MatchingStageMetrics</a>,<br/>
&nbsp; StageName<br/>
}<br/>
<br/>
import scala.collection.immutable.ListMap<br/>
<br/>
/**<br/>
 * A Performance Regression Analysis report for the given pair of [[<a href="SparkAppPerfReport.scala.html#L26" title="utils/spark/SparkAppPerfReport.scala:26">SparkAppPerfReport</a>]] sets.<br/>
 * This class will verify whether the internal structures of the applications match, and if so, will produce a<br/>
 * per-<a href="PerStageReport.scala.html#L26" title="utils/spark/PerStageReport.scala:26">stage</a> regression analysis. If the applications don't match, then only a summarized view will be provided.<br/>
 *<br/>
 * @param appPerfReports1 Spark app perf report set #1 (e.g. &quot;before&quot;)<br/>
 * @param appPerfReports2 Spark app perf report set #2 (e.g. &quot;after&quot;)<br/>
 */<br/>
<a id="L23">&#x200c;</a>class <span class="linkable">SparkAppPerfRegressionReport</span>(<br/>
&nbsp; &nbsp; val appPerfReports1: Seq[<a href="SparkAppPerfReport.scala.html#L26" title="utils/spark/SparkAppPerfReport.scala:26">SparkAppPerfReport</a>],<br/>
&nbsp; &nbsp; val appPerfReports2: Seq[<a href="SparkAppPerfReport.scala.html#L26" title="utils/spark/SparkAppPerfReport.scala:26">SparkAppPerfReport</a>])<br/>
&nbsp; &nbsp; extends <a href="SparkAppPerfReportBase.scala.html#L19" title="utils/spark/SparkAppPerfReportBase.scala:19">SparkAppPerfReportBase</a>[JobName, StageName, <a href="#L50" title="utils/spark/SparkAppPerfRegressionReport.scala:50">RegressionAnalysisPerfMetrics</a>] {<br/>
<br/>
&nbsp; override protected def <a href="SparkAppPerfReportBase.scala.html#L33" title="utils/spark/SparkAppPerfReportBase.scala:33">buildPerJobData</a>: () =&gt; Seq[(JobName, Seq[(StageName, <a href="#L50" title="utils/spark/SparkAppPerfRegressionReport.scala:50">RegressionAnalysisPerfMetrics</a>)])] =<br/>
&nbsp; &nbsp; () =&gt; {<br/>
&nbsp; &nbsp; &nbsp; val (appMatcher1, appMatcher2) = <a href="SparkAppReportMatcher.scala.html#L17" title="utils/spark/SparkAppReportMatcher.scala:17">SparkAppReportMatcher</a>.<a href="SparkAppReportMatcher.scala.html#L299" title="utils/spark/SparkAppReportMatcher.scala:299">matchAppReportSets</a>(appPerfReports1, appPerfReports2)<br/>
&nbsp; &nbsp; &nbsp; (appMatcher1.<a href="SparkAppReportMatcher.scala.html#L28" title="utils/spark/SparkAppReportMatcher.scala:28">matchingAppReports</a> zip appMatcher2.<a href="SparkAppReportMatcher.scala.html#L28" title="utils/spark/SparkAppReportMatcher.scala:28">matchingAppReports</a>).map(<a href="#L77" title="utils/spark/SparkAppPerfRegressionReport.scala:77">perJobRegressionAnalysis</a>)<br/>
&nbsp; &nbsp; }<br/>
<br/>
&nbsp; override protected def <a href="SparkAppPerfReportBase.scala.html#L40" title="utils/spark/SparkAppPerfReportBase.scala:40">buildSummaryReport</a>: () =&gt; <a href="#L50" title="utils/spark/SparkAppPerfRegressionReport.scala:50">RegressionAnalysisPerfMetrics</a> =<br/>
&nbsp; &nbsp; () =&gt; <a href="#L50" title="utils/spark/SparkAppPerfRegressionReport.scala:50">RegressionAnalysisPerfMetrics</a>(appPerfReports1.map(_.<a href="SparkAppPerfReportBase.scala.html#L63" title="utils/spark/SparkAppPerfReportBase.scala:63">summaryReport</a>), appPerfReports2.map(_.<a href="SparkAppPerfReportBase.scala.html#L63" title="utils/spark/SparkAppPerfReportBase.scala:63">summaryReport</a>))<br/>
<br/>
&nbsp; override protected def <a href="SparkAppPerfReportBase.scala.html#L48" title="utils/spark/SparkAppPerfReportBase.scala:48">buildJobLevelReport</a>: () =&gt; ListMap[JobName, <a href="#L50" title="utils/spark/SparkAppPerfRegressionReport.scala:50">RegressionAnalysisPerfMetrics</a>] = () =&gt; {<br/>
&nbsp; &nbsp; var jobLevelData = ListMap[JobName, <a href="#L50" title="utils/spark/SparkAppPerfRegressionReport.scala:50">RegressionAnalysisPerfMetrics</a>]()<br/>
&nbsp; &nbsp; if (<a href="SparkAppPerfReportBase.scala.html#L56" title="utils/spark/SparkAppPerfReportBase.scala:56">perJobReport</a>.<a href="PerJobReport.scala.html#L40" title="utils/spark/PerJobReport.scala:40">isValid</a>) {<br/>
&nbsp; &nbsp; &nbsp; val (appMatcher1, appMatcher2) = <a href="SparkAppReportMatcher.scala.html#L17" title="utils/spark/SparkAppReportMatcher.scala:17">SparkAppReportMatcher</a>.<a href="SparkAppReportMatcher.scala.html#L299" title="utils/spark/SparkAppReportMatcher.scala:299">matchAppReportSets</a>(appPerfReports1, appPerfReports2)<br/>
&nbsp; &nbsp; &nbsp; (appMatcher1.<a href="SparkAppReportMatcher.scala.html#L28" title="utils/spark/SparkAppReportMatcher.scala:28">matchingAppReports</a> zip appMatcher2.<a href="SparkAppReportMatcher.scala.html#L28" title="utils/spark/SparkAppReportMatcher.scala:28">matchingAppReports</a>)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; .foreach(jobLevelData += <a href="#L83" title="utils/spark/SparkAppPerfRegressionReport.scala:83">jobLevelRegressionAnalysis</a>(_))<br/>
&nbsp; &nbsp; }<br/>
&nbsp; &nbsp; jobLevelData<br/>
&nbsp; }<br/>
}<br/>
<br/>
<a id="L48">&#x200c;</a>object <span class="linkable">SparkAppPerfRegressionReport</span> {<br/>
&nbsp; type <a href="#L50" title="utils/spark/SparkAppPerfRegressionReport.scala:50">RegressionAnalysisPerfMetrics</a> = <a href="SparkAppPerfReport.scala.html#L145" title="utils/spark/SparkAppPerfReport.scala:145">PerfMetrics</a>[<a href="../RegressionAnalysis.scala.html#L18" title="utils/RegressionAnalysis.scala:18">RegressionAnalysis</a>]<br/>
<a id="L50">&#x200c;</a>&nbsp; private def <span class="linkable">RegressionAnalysisPerfMetrics</span>(<br/>
&nbsp; &nbsp; &nbsp; perfMetricsSeq1: Seq[<a href="SparkAppPerfReport.scala.html#L145" title="utils/spark/SparkAppPerfReport.scala:145">PerfMetrics</a>[PerfValue]],<br/>
&nbsp; &nbsp; &nbsp; perfMetricsSeq2: Seq[<a href="SparkAppPerfReport.scala.html#L145" title="utils/spark/SparkAppPerfReport.scala:145">PerfMetrics</a>[PerfValue]]): <a href="#L50" title="utils/spark/SparkAppPerfRegressionReport.scala:50">RegressionAnalysisPerfMetrics</a> = {<br/>
&nbsp; &nbsp; // Only analyze perfMetrics that should be used in regression reports<br/>
&nbsp; &nbsp; val perfMetricsToAnalyze = perfMetricsSeq1.flatMap(_.keys).distinct.filter(_.useInRegressionReport)<br/>
<br/>
&nbsp; &nbsp; perfMetricsToAnalyze<br/>
&nbsp; &nbsp; &nbsp; .map(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; perfMetric =&gt;<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; perfMetric -&gt;<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new <a href="../RegressionAnalysis.scala.html#L18" title="utils/RegressionAnalysis.scala:18">RegressionAnalysis</a>(perfMetricsSeq1.map(_(perfMetric)), perfMetricsSeq2.map(_(perfMetric)), perfMetric))<br/>
&nbsp; &nbsp; &nbsp; .toMap<br/>
&nbsp; }<br/>
<br/>
&nbsp; /**<br/>
&nbsp;&nbsp; * 'executorCpuTimeMs' values were found to be distributing normally across different application runs, so they are<br/>
&nbsp;&nbsp; * the go-to metric for measuring performance regression of Spark apps<br/>
&nbsp;&nbsp; */<br/>
&nbsp; val DEFAULT_REGRESSION_METRIC: <a href="../PerfMetric.scala.html#L17" title="utils/PerfMetric.scala:17">PerfMetric</a> = <a href="../PerfMetric.scala.html#L17" title="utils/PerfMetric.scala:17">PerfMetric</a>.EXECUTOR_CPU_TIME<br/>
<br/>
<a id="L70">&#x200c;</a>&nbsp; private def <span class="linkable">perStageRegressionAnalysis</span>(matchingStageMetricsPair: (<a href="SparkAppReportMatcher.scala.html#L53" title="utils/spark/SparkAppReportMatcher.scala:53">MatchingStageMetrics</a>, <a href="SparkAppReportMatcher.scala.html#L53" title="utils/spark/SparkAppReportMatcher.scala:53">MatchingStageMetrics</a>)) = {<br/>
&nbsp; &nbsp; matchingStageMetricsPair._1.stageName -&gt;<br/>
&nbsp; &nbsp; &nbsp; <a href="#L50" title="utils/spark/SparkAppPerfRegressionReport.scala:50">RegressionAnalysisPerfMetrics</a>(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; matchingStageMetricsPair._1.stageMetricsSeq.map(_.perfMetrics),<br/>
&nbsp; &nbsp; &nbsp; &nbsp; matchingStageMetricsPair._2.stageMetricsSeq.map(_.perfMetrics))<br/>
&nbsp; }<br/>
<br/>
<a id="L77">&#x200c;</a>&nbsp; private def <span class="linkable">perJobRegressionAnalysis</span>(matchingJobMetricsPair: (<a href="SparkAppReportMatcher.scala.html#L113" title="utils/spark/SparkAppReportMatcher.scala:113">MatchingJobMetrics</a>, <a href="SparkAppReportMatcher.scala.html#L113" title="utils/spark/SparkAppReportMatcher.scala:113">MatchingJobMetrics</a>)) = {<br/>
&nbsp; &nbsp; matchingJobMetricsPair._1.<a href="../../html/SparkAppHtmlUtils.scala.html#L348" title="html/SparkAppHtmlUtils.scala:348">jobName</a> -&gt;<br/>
&nbsp; &nbsp; &nbsp; (matchingJobMetricsPair._1.matchingStageMetricsSeq zip matchingJobMetricsPair._2.matchingStageMetricsSeq)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; .map(<a href="#L70" title="utils/spark/SparkAppPerfRegressionReport.scala:70">perStageRegressionAnalysis</a>)<br/>
&nbsp; }<br/>
<br/>
<a id="L83">&#x200c;</a>&nbsp; private def <span class="linkable">jobLevelRegressionAnalysis</span>(matchingJobMetricsPair: (<a href="SparkAppReportMatcher.scala.html#L113" title="utils/spark/SparkAppReportMatcher.scala:113">MatchingJobMetrics</a>, <a href="SparkAppReportMatcher.scala.html#L113" title="utils/spark/SparkAppReportMatcher.scala:113">MatchingJobMetrics</a>)) = {<br/>
&nbsp; &nbsp; matchingJobMetricsPair._1.<a href="../../html/SparkAppHtmlUtils.scala.html#L348" title="html/SparkAppHtmlUtils.scala:348">jobName</a> -&gt; <a href="#L50" title="utils/spark/SparkAppPerfRegressionReport.scala:50">RegressionAnalysisPerfMetrics</a>(<br/>
&nbsp; &nbsp; &nbsp; <a href="SparkAppPerfAggregateReport.scala.html#L17" title="utils/spark/SparkAppPerfAggregateReport.scala:17">SparkAppPerfAggregateReport</a>.<a href="SparkAppPerfAggregateReport.scala.html#L58" title="utils/spark/SparkAppPerfAggregateReport.scala:58">accumulatedPerfMetrics</a>(matchingJobMetricsPair._1),<br/>
&nbsp; &nbsp; &nbsp; <a href="SparkAppPerfAggregateReport.scala.html#L17" title="utils/spark/SparkAppPerfAggregateReport.scala:17">SparkAppPerfAggregateReport</a>.<a href="SparkAppPerfAggregateReport.scala.html#L58" title="utils/spark/SparkAppPerfAggregateReport.scala:58">accumulatedPerfMetrics</a>(matchingJobMetricsPair._2))<br/>
&nbsp; }<br/>
}<br/>
</code>

 </body>
</html>
