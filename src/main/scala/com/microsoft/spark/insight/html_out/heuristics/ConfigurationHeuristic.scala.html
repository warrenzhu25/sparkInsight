<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>heuristics/ConfigurationHeuristic.scala - Spark Insight</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}


  </style>
 </head>
 <body>

  <h1>heuristics/ConfigurationHeuristic.scala - Spark Insight</h1>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L101">CompressedOopsEvaluator</a></li>
<li><a href="#L34">ConfigEvaluator</a></li>
<li><a href="#L30">ConfigurationHeuristic</a></li>
<li><a href="#L83">ExecutorCoreEvaluator</a></li>
<li><a href="#L118">ExecutorMemoryOverheadEvaluator</a></li>
<li><a href="#L52">KyroSerializerEvaluator</a></li>
<li><a href="#L67">ShuffleServiceEvaluator</a></li>
<li><a href="#L46">SparkConfigEvaluator</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L47">evaluate</a></li>
<li><a href="#L48">getProperty</a></li>
</ul>
 <h2>Source code</h2>

  <code>/*<br/>
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not<br/>
 * use this file except in compliance with the License. You may obtain a copy of<br/>
 * the License at<br/>
 *<br/>
 * http://www.apache.org/licenses/LICENSE-2.0<br/>
 *<br/>
 * Unless required by applicable law or agreed to in writing, software<br/>
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT<br/>
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the<br/>
 * License for the specific language governing permissions and limitations under<br/>
 * the License.<br/>
 */<br/>
<br/>
package com.microsoft.spark.insight.heuristics<br/>
<br/>
import com.microsoft.spark.insight.fetcher.<a href="../fetcher/SparkApplicationData.scala.html#L21" title="fetcher/SparkApplicationData.scala:21">SparkApplicationData</a><br/>
import com.microsoft.spark.insight.util.Utils<br/>
<br/>
import <a href="ConfigUtils.scala.html#L20" title="heuristics/ConfigUtils.scala:20">ConfigUtils</a>._<br/>
<br/>
/**<br/>
 * A heuristic based on an app's known configuration.<br/>
 *<br/>
 * The results from this heuristic primarily inform users about key app configuration settings, including<br/>
 * driver memory, driver cores, executor cores, executor instances, executor memory, and the serializer.<br/>
 *<br/>
 * It also checks whether the values specified are within threshold.<br/>
 */<br/>
<a id="L30">&#x200c;</a>object <span class="linkable">ConfigurationHeuristic</span> extends <a href="Heuristic.scala.html#L19" title="heuristics/Heuristic.scala:19">Heuristic</a> {<br/>
&nbsp; override val evaluators: Seq[<a href="SparkEvaluator.scala.html#L22" title="heuristics/SparkEvaluator.scala:22">SparkEvaluator</a>] = Seq(<a href="#L34" title="heuristics/ConfigurationHeuristic.scala:34">ConfigEvaluator</a>)<br/>
}<br/>
<br/>
<a id="L34">&#x200c;</a>object <span class="linkable">ConfigEvaluator</span> extends <a href="SparkEvaluator.scala.html#L22" title="heuristics/SparkEvaluator.scala:22">SparkEvaluator</a> {<br/>
&nbsp; private val configEvaluators = Seq(<br/>
&nbsp; &nbsp; <a href="#L52" title="heuristics/ConfigurationHeuristic.scala:52">KyroSerializerEvaluator</a>,<br/>
&nbsp; &nbsp; <a href="#L67" title="heuristics/ConfigurationHeuristic.scala:67">ShuffleServiceEvaluator</a>,<br/>
&nbsp; &nbsp; <a href="#L83" title="heuristics/ConfigurationHeuristic.scala:83">ExecutorCoreEvaluator</a>,<br/>
&nbsp; &nbsp; <a href="#L118" title="heuristics/ConfigurationHeuristic.scala:118">ExecutorMemoryOverheadEvaluator</a>,<br/>
&nbsp; &nbsp; <a href="#L101" title="heuristics/ConfigurationHeuristic.scala:101">CompressedOopsEvaluator</a><br/>
&nbsp; )<br/>
&nbsp; override def <a href="#L47" title="heuristics/ConfigurationHeuristic.scala:47">evaluate</a>(sparkAppData: <a href="../fetcher/SparkApplicationData.scala.html#L21" title="fetcher/SparkApplicationData.scala:21">SparkApplicationData</a>): Seq[<a href="HeuristicResult.scala.html#L18" title="heuristics/HeuristicResult.scala:18">AnalysisResult</a>] =<br/>
&nbsp; &nbsp; Seq(<a href="HeuristicResult.scala.html#L50" title="heuristics/HeuristicResult.scala:50">ConfigResult</a>(configEvaluators.flatMap(e =&gt; e.<a href="#L47" title="heuristics/ConfigurationHeuristic.scala:47">evaluate</a>(sparkAppData.appConf))))<br/>
}<br/>
<br/>
<a id="L46">&#x200c;</a>trait <span class="linkable">SparkConfigEvaluator</span> {<br/>
<a id="L47">&#x200c;</a>&nbsp; def <span class="linkable">evaluate</span>(appConf: Map[String, String]): Option[<a href="HeuristicResult.scala.html#L61" title="heuristics/HeuristicResult.scala:61">ConfigRowResult</a>]<br/>
<a id="L48">&#x200c;</a>&nbsp; def <span class="linkable">getProperty</span>(appConf: Map[String, String], key: String): Option[String] =<br/>
&nbsp; &nbsp; appConf.<a href="../fetcher/SparkRestClient.scala.html#L229" title="fetcher/SparkRestClient.scala:229">get</a>(key)<br/>
}<br/>
<br/>
<a id="L52">&#x200c;</a>object <span class="linkable">KyroSerializerEvaluator</span> extends <a href="#L46" title="heuristics/ConfigurationHeuristic.scala:46">SparkConfigEvaluator</a> {<br/>
&nbsp; override def <a href="#L47" title="heuristics/ConfigurationHeuristic.scala:47">evaluate</a>(appConf: Map[String, String]): Option[<a href="HeuristicResult.scala.html#L61" title="heuristics/HeuristicResult.scala:61">ConfigRowResult</a>] = {<br/>
&nbsp; &nbsp; val sparkSerializer = <a href="#L48" title="heuristics/ConfigurationHeuristic.scala:48">getProperty</a>(appConf, SPARK_SERIALIZER_KEY)<br/>
&nbsp; &nbsp; if (sparkSerializer.isEmpty) {<br/>
&nbsp; &nbsp; &nbsp; Some(<a href="HeuristicResult.scala.html#L61" title="heuristics/HeuristicResult.scala:61">ConfigRowResult</a>(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; SPARK_SERIALIZER_KEY,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;KyroSerializer is Not Enabled.&quot;,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;org.apache.spark.serializer.KryoSerializer&quot;))<br/>
&nbsp; &nbsp; } else {<br/>
&nbsp; &nbsp; &nbsp; None<br/>
&nbsp; &nbsp; }<br/>
&nbsp; }<br/>
}<br/>
<br/>
<a id="L67">&#x200c;</a>object <span class="linkable">ShuffleServiceEvaluator</span> extends <a href="#L46" title="heuristics/ConfigurationHeuristic.scala:46">SparkConfigEvaluator</a> {<br/>
&nbsp; override def <a href="#L47" title="heuristics/ConfigurationHeuristic.scala:47">evaluate</a>(appConf: Map[String, String]): Option[<a href="HeuristicResult.scala.html#L61" title="heuristics/HeuristicResult.scala:61">ConfigRowResult</a>] = {<br/>
&nbsp; &nbsp; val dynamicAllocationEnabled = <a href="#L48" title="heuristics/ConfigurationHeuristic.scala:48">getProperty</a>(appConf, SPARK_DYNAMIC_ALLOCATION_ENABLED).getOrElse(&quot;false&quot;).toBoolean<br/>
&nbsp; &nbsp; val shuffleServiceEnabled = <a href="#L48" title="heuristics/ConfigurationHeuristic.scala:48">getProperty</a>(appConf, SPARK_SHUFFLE_SERVICE_ENABLED).getOrElse(&quot;false&quot;).toBoolean<br/>
&nbsp; &nbsp; if (dynamicAllocationEnabled &amp;&amp; !shuffleServiceEnabled) {<br/>
&nbsp; &nbsp; &nbsp; Some(<a href="HeuristicResult.scala.html#L61" title="heuristics/HeuristicResult.scala:61">ConfigRowResult</a>(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; SPARK_DYNAMIC_ALLOCATION_ENABLED,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;false&quot;,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;Spark shuffle service is not enabled when dynamic allocation is enabled.&quot;,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;true&quot;))<br/>
&nbsp; &nbsp; } else {<br/>
&nbsp; &nbsp; &nbsp; None<br/>
&nbsp; &nbsp; }<br/>
&nbsp; }<br/>
}<br/>
<br/>
<a id="L83">&#x200c;</a>object <span class="linkable">ExecutorCoreEvaluator</span> extends <a href="#L46" title="heuristics/ConfigurationHeuristic.scala:46">SparkConfigEvaluator</a> {<br/>
&nbsp; private val MIN_EXECUTOR_CORES = 2<br/>
&nbsp; private val MAX_EXECUTOR_CORES = 5<br/>
<br/>
&nbsp; override def <a href="#L47" title="heuristics/ConfigurationHeuristic.scala:47">evaluate</a>(appConf: Map[String, String]): Option[<a href="HeuristicResult.scala.html#L61" title="heuristics/HeuristicResult.scala:61">ConfigRowResult</a>] = {<br/>
&nbsp; &nbsp; val executorCores = <a href="#L48" title="heuristics/ConfigurationHeuristic.scala:48">getProperty</a>(appConf, SPARK_EXECUTOR_CORES_KEY).getOrElse(&quot;1&quot;).toInt<br/>
&nbsp; &nbsp; if (executorCores &lt; MIN_EXECUTOR_CORES || executorCores &gt;= MAX_EXECUTOR_CORES) {<br/>
&nbsp; &nbsp; &nbsp; Some(<a href="HeuristicResult.scala.html#L61" title="heuristics/HeuristicResult.scala:61">ConfigRowResult</a>(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; SPARK_EXECUTOR_CORES_KEY,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; executorCores.toString,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;Spark executor cores should be between 2 and 4. Too small cores will have higher overhead, and too many cores lead to poor performance due to HDFS concurrent read issues.&quot;,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;4&quot;))<br/>
&nbsp; &nbsp; } else {<br/>
&nbsp; &nbsp; &nbsp; None<br/>
&nbsp; &nbsp; }<br/>
&nbsp; }<br/>
}<br/>
<br/>
<a id="L101">&#x200c;</a>object <span class="linkable">CompressedOopsEvaluator</span> extends <a href="#L46" title="heuristics/ConfigurationHeuristic.scala:46">SparkConfigEvaluator</a> {<br/>
&nbsp; private val COMPRESSED_OOPS_THRESHOLD = 32<br/>
<br/>
&nbsp; override def <a href="#L47" title="heuristics/ConfigurationHeuristic.scala:47">evaluate</a>(appConf: Map[String, String]): Option[<a href="HeuristicResult.scala.html#L61" title="heuristics/HeuristicResult.scala:61">ConfigRowResult</a>] = {<br/>
&nbsp; &nbsp; val executorMemory = <a href="#L48" title="heuristics/ConfigurationHeuristic.scala:48">getProperty</a>(appConf, SPARK_EXECUTOR_MEMORY_KEY).getOrElse(&quot;1g&quot;)<br/>
&nbsp; &nbsp; if (Utils.byteStringAsGb(executorMemory) &lt; COMPRESSED_OOPS_THRESHOLD) {<br/>
&nbsp; &nbsp; &nbsp; Some(<a href="HeuristicResult.scala.html#L61" title="heuristics/HeuristicResult.scala:61">ConfigRowResult</a>(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;spark.executor.extraJavaOptions&quot;,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;When executor memory is smaller than 32g, use this option to make pointers be four bytes instead of eight.&quot;,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;-XX:+UseCompressedOops&quot;))<br/>
&nbsp; &nbsp; } else {<br/>
&nbsp; &nbsp; &nbsp; None<br/>
&nbsp; &nbsp; }<br/>
&nbsp; }<br/>
}<br/>
<br/>
<a id="L118">&#x200c;</a>object <span class="linkable">ExecutorMemoryOverheadEvaluator</span> extends <a href="#L46" title="heuristics/ConfigurationHeuristic.scala:46">SparkConfigEvaluator</a> {<br/>
&nbsp; override def <a href="#L47" title="heuristics/ConfigurationHeuristic.scala:47">evaluate</a>(appConf: Map[String, String]): Option[<a href="HeuristicResult.scala.html#L61" title="heuristics/HeuristicResult.scala:61">ConfigRowResult</a>] = {<br/>
&nbsp; &nbsp; val offheapEnabled = <a href="#L48" title="heuristics/ConfigurationHeuristic.scala:48">getProperty</a>(appConf, &quot;spark.memory.offHeap.enabled&quot;).getOrElse(&quot;false&quot;).toBoolean<br/>
&nbsp; &nbsp; val offHeapSize = <a href="#L48" title="heuristics/ConfigurationHeuristic.scala:48">getProperty</a>(appConf, &quot;spark.memory.offHeap.size&quot;).getOrElse(&quot;0&quot;).toInt<br/>
&nbsp; &nbsp; val memoryOverhead = <a href="#L48" title="heuristics/ConfigurationHeuristic.scala:48">getProperty</a>(appConf, SPARK_EXECUTOR_MEMORY_OVERHEAD).getOrElse(&quot;384&quot;)<br/>
&nbsp; &nbsp; val memory = <a href="#L48" title="heuristics/ConfigurationHeuristic.scala:48">getProperty</a>(appConf, SPARK_EXECUTOR_MEMORY_KEY).getOrElse(&quot;1g&quot;)<br/>
&nbsp; &nbsp; val targetOverhead = offHeapSize + Math.<a href="../utils/AggregatePerfValue.scala.html#L24" title="utils/AggregatePerfValue.scala:24">min</a>(384, Utils.byteStringAsMb(memory) / 10)<br/>
&nbsp; &nbsp; if (offheapEnabled &amp;&amp; (targetOverhead &gt; Utils.byteStringAsMb(memoryOverhead))) {<br/>
&nbsp; &nbsp; &nbsp; Some(<a href="HeuristicResult.scala.html#L61" title="heuristics/HeuristicResult.scala:61">ConfigRowResult</a>(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; SPARK_EXECUTOR_MEMORY_OVERHEAD,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; memory,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &quot;When executor memory off heap is enabled, memory overhead <a href="../fetcher/status/statusapiv1.scala.html#L305" title="fetcher/status/statusapiv1.scala:305">value</a> should add off heap size up.&quot;,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; targetOverhead + &quot;m&quot;))<br/>
&nbsp; &nbsp; } else {<br/>
&nbsp; &nbsp; &nbsp; None<br/>
&nbsp; &nbsp; }<br/>
&nbsp; }<br/>
}<br/>
</code>

 </body>
</html>
