<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>heuristics/StagesWithFailedTasksHeuristic.scala - Spark Insight</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}


  </style>
 </head>
 <body>

  <h1>heuristics/StagesWithFailedTasksHeuristic.scala - Spark Insight</h1>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L56">Evaluator</a></li>
<li><a href="#L26">StagesWithFailedTasksHeuristic</a></li>
<li><a href="#L49">StagesWithFailedTasksHeuristic</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L65">getErrorsSeverity</a></li>
<li><a href="#L106">getStageSeverity</a></li>
<li><a href="#L133">hasError</a></li>
</ul>
 <h2>Source code</h2>

  <code>/*<br/>
 * Licensed to the Apache Software Foundation (ASF) under one or more<br/>
 * contributor license agreements.&nbsp; See the NOTICE file distributed with<br/>
 * this work for additional information regarding copyright ownership.<br/>
 * The ASF licenses this file to You under the Apache License, Version 2.0<br/>
 * (the &quot;License&quot;); you may not use this file except in compliance with<br/>
 * the License.&nbsp; You may obtain a copy of the License at<br/>
 *<br/>
 *&nbsp; &nbsp; http://www.apache.org/licenses/LICENSE-2.0<br/>
 *<br/>
 * Unless required by applicable law or agreed to in writing, software<br/>
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,<br/>
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<br/>
 * See the License for the specific language governing permissions and<br/>
 * limitations under the License.<br/>
 */<br/>
<br/>
package com.microsoft.spark.insight.heuristics<br/>
<br/>
import com.microsoft.spark.insight.fetcher.<a href="../fetcher/SparkApplicationData.scala.html#L21" title="fetcher/SparkApplicationData.scala:21">SparkApplicationData</a><br/>
import com.microsoft.spark.insight.fetcher.<a href="../fetcher/status/statusapiv1.scala.html#L111" title="fetcher/status/statusapiv1.scala:111">status</a>._<br/>
<br/>
/**<br/>
 * A heuristic based on errors encountered by failed <a href="../fetcher/status/statusapiv1.scala.html#L180" title="fetcher/status/statusapiv1.scala:180">tasks</a>. Tasks may fail due to Overhead memory issues or OOM errors. These errors are checked and warning is given accordingly.<br/>
 */<br/>
<a id="L26">&#x200c;</a>class <span class="linkable">StagesWithFailedTasksHeuristic</span>()<br/>
&nbsp; extends <a href="Heuristic.scala.html#L19" title="heuristics/Heuristic.scala:19">Heuristic</a> {<br/>
<br/>
&nbsp; import <a href="#L26" title="heuristics/StagesWithFailedTasksHeuristic.scala:26">StagesWithFailedTasksHeuristic</a>._<br/>
<br/>
&nbsp; override def <a href="../cli/AppReportSets.scala.html#L43" title="cli/AppReportSets.scala:43">apply</a>(data: <a href="../fetcher/SparkApplicationData.scala.html#L21" title="fetcher/SparkApplicationData.scala:21">SparkApplicationData</a>): <a href="HeuristicResult.scala.html#L39" title="heuristics/HeuristicResult.scala:39">HeuristicResult</a> = {<br/>
&nbsp; &nbsp; val evaluator = new <a href="DriverHeuristic.scala.html#L116" title="heuristics/DriverHeuristic.scala:116">Evaluator</a>(this, data)<br/>
&nbsp; &nbsp; var resultDetails = Seq(<br/>
&nbsp; &nbsp; &nbsp; <a href="HeuristicResult.scala.html#L68" title="heuristics/HeuristicResult.scala:68">SimpleRowResult</a>(&quot;Stages with OOM errors&quot;, evaluator.stagesWithOOMError.toString),<br/>
&nbsp; &nbsp; &nbsp; <a href="HeuristicResult.scala.html#L68" title="heuristics/HeuristicResult.scala:68">SimpleRowResult</a>(&quot;Stages with Overhead memory errors&quot;, evaluator.stagesWithOverheadError.toString)<br/>
&nbsp; &nbsp; )<br/>
&nbsp; &nbsp; if (evaluator.severityOverheadStages.<a href="../utils/spark/SparkMetricsRowConversionUtils.scala.html#L242" title="utils/spark/SparkMetricsRowConversionUtils.scala:242">getValue</a> &gt;= Severity.MODERATE.<a href="../utils/spark/SparkMetricsRowConversionUtils.scala.html#L242" title="utils/spark/SparkMetricsRowConversionUtils.scala:242">getValue</a>)<br/>
&nbsp; &nbsp; &nbsp; resultDetails = resultDetails :+ new <a href="HeuristicResult.scala.html#L68" title="heuristics/HeuristicResult.scala:68">SimpleRowResult</a>(&quot;Overhead memory errors&quot;, &quot;Some <a href="../fetcher/status/statusapiv1.scala.html#L180" title="fetcher/status/statusapiv1.scala:180">tasks</a> have failed due to overhead memory error. Please try increasing spark.yarn.executor.memoryOverhead by &quot; + increaseMemoryBy + &quot; in spark.yarn.executor.memoryOverhead&quot;)<br/>
&nbsp; &nbsp; //TODO: refine recommendations<br/>
&nbsp; &nbsp; if (evaluator.severityOOMStages.<a href="../utils/spark/SparkMetricsRowConversionUtils.scala.html#L242" title="utils/spark/SparkMetricsRowConversionUtils.scala:242">getValue</a> &gt;= Severity.MODERATE.<a href="../utils/spark/SparkMetricsRowConversionUtils.scala.html#L242" title="utils/spark/SparkMetricsRowConversionUtils.scala:242">getValue</a>)<br/>
&nbsp; &nbsp; &nbsp; resultDetails = resultDetails :+ new <a href="HeuristicResult.scala.html#L68" title="heuristics/HeuristicResult.scala:68">SimpleRowResult</a>(&quot;OOM errors&quot;, &quot;Some <a href="../fetcher/status/statusapiv1.scala.html#L180" title="fetcher/status/statusapiv1.scala:180">tasks</a> have failed due to OOM error. Try increasing spark.executor.memory or decreasing spark.memory.fraction (take a look at unified memory heuristic) or decreasing number of cores.&quot;)<br/>
&nbsp; &nbsp; <a href="HeuristicResult.scala.html#L39" title="heuristics/HeuristicResult.scala:39">HeuristicResult</a>(<br/>
&nbsp; &nbsp; &nbsp; <a href="../fetcher/status/statusapiv1.scala.html#L48" title="fetcher/status/statusapiv1.scala:48">name</a>,<br/>
&nbsp; &nbsp; &nbsp; Seq(<a href="HeuristicResult.scala.html#L56" title="heuristics/HeuristicResult.scala:56">SimpleResult</a>(&quot;Failed Tasks summary&quot;, resultDetails))<br/>
&nbsp; &nbsp; )<br/>
&nbsp; }<br/>
}<br/>
<br/>
<a id="L49">&#x200c;</a>object <span class="linkable">StagesWithFailedTasksHeuristic</span> {<br/>
<br/>
&nbsp; val OOM_ERROR = &quot;java.lang.OutOfMemoryError&quot;<br/>
&nbsp; val OVERHEAD_MEMORY_ERROR = &quot;killed by YARN for exceeding memory limits&quot;<br/>
&nbsp; val ratioThreshold: Double = 2<br/>
&nbsp; val increaseMemoryBy: String = &quot;1G&quot;<br/>
<br/>
<a id="L56">&#x200c;</a>&nbsp; class <span class="linkable">Evaluator</span>(heuristic: <a href="#L26" title="heuristics/StagesWithFailedTasksHeuristic.scala:26">StagesWithFailedTasksHeuristic</a>, data: <a href="../fetcher/SparkApplicationData.scala.html#L21" title="fetcher/SparkApplicationData.scala:21">SparkApplicationData</a>) {<br/>
&nbsp; &nbsp; lazy val stagesWithFailedTasks: Seq[<a href="../fetcher/status/statusapiv1.scala.html#L148" title="fetcher/status/statusapiv1.scala:148">StageData</a>] = data.stageData.filter(_.<a href="../fetcher/status/statusapiv1.scala.html#L116" title="fetcher/status/statusapiv1.scala:116">numFailedTasks</a> &gt; 0)<br/>
&nbsp; &nbsp; lazy val (severityOOMStages: Severity, severityOverheadStages: Severity, stagesWithOOMError: Int, stagesWithOverheadError: Int) = <a href="#L65" title="heuristics/StagesWithFailedTasksHeuristic.scala:65">getErrorsSeverity</a><br/>
&nbsp; &nbsp; lazy val severity: Severity = Severity.<a href="../utils/AggregatePerfValue.scala.html#L26" title="utils/AggregatePerfValue.scala:26">max</a>(severityOverheadStages, severityOOMStages)<br/>
&nbsp; &nbsp; val executorCount = data.executorSummaries.filterNot(_.<a href="../fetcher/status/statusapiv1.scala.html#L47" title="fetcher/status/statusapiv1.scala:47">id</a>.equals(&quot;driver&quot;)).size<br/>
<br/>
&nbsp; &nbsp; /**<br/>
&nbsp; &nbsp;&nbsp; * @return : returns the OOM and Overhead memory errors severity<br/>
&nbsp; &nbsp;&nbsp; */<br/>
<a id="L65">&#x200c;</a>&nbsp; &nbsp; private def <span class="linkable">getErrorsSeverity</span>: (Severity, Severity, Int, Int) = {<br/>
&nbsp; &nbsp; &nbsp; var severityOOM: Severity = Severity.NONE<br/>
&nbsp; &nbsp; &nbsp; var severityOverhead: Severity = Severity.NONE<br/>
&nbsp; &nbsp; &nbsp; var stagesWithOOMError: Int = 0<br/>
&nbsp; &nbsp; &nbsp; var stagesWithOverheadError: Int = 0<br/>
&nbsp; &nbsp; &nbsp; stagesWithFailedTasks.foreach(stageData =&gt; {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; val <a href="../fetcher/status/statusapiv1.scala.html#L154" title="fetcher/status/statusapiv1.scala:154">numCompleteTasks</a>: Int = stageData.<a href="../fetcher/status/statusapiv1.scala.html#L154" title="fetcher/status/statusapiv1.scala:154">numCompleteTasks</a><br/>
&nbsp; &nbsp; &nbsp; &nbsp; var failedOOMTasks = 0<br/>
&nbsp; &nbsp; &nbsp; &nbsp; var failedOverheadMemoryTasks = 0<br/>
&nbsp; &nbsp; &nbsp; &nbsp; stageData.<a href="../fetcher/status/statusapiv1.scala.html#L180" title="fetcher/status/statusapiv1.scala:180">tasks</a>.values.foreach((taskData: <a href="../fetcher/status/statusapiv1.scala.html#L190" title="fetcher/status/statusapiv1.scala:190">TaskData</a>) =&gt; {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var <a href="../fetcher/status/statusapiv1.scala.html#L201" title="fetcher/status/statusapiv1.scala:201">errorMessage</a>: String = taskData.<a href="../fetcher/status/statusapiv1.scala.html#L201" title="fetcher/status/statusapiv1.scala:201">errorMessage</a>.<a href="../fetcher/SparkRestClient.scala.html#L229" title="fetcher/SparkRestClient.scala:229">get</a><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; failedOOMTasks = <a href="#L133" title="heuristics/StagesWithFailedTasksHeuristic.scala:133">hasError</a>(<a href="../fetcher/status/statusapiv1.scala.html#L201" title="fetcher/status/statusapiv1.scala:201">errorMessage</a>, OOM_ERROR, failedOOMTasks)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; failedOverheadMemoryTasks = <a href="#L133" title="heuristics/StagesWithFailedTasksHeuristic.scala:133">hasError</a>(<a href="../fetcher/status/statusapiv1.scala.html#L201" title="fetcher/status/statusapiv1.scala:201">errorMessage</a>, OVERHEAD_MEMORY_ERROR, failedOverheadMemoryTasks)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; })<br/>
&nbsp; &nbsp; &nbsp; &nbsp; if (failedOOMTasks &gt; 0) {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stagesWithOOMError = stagesWithOOMError + 1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; }<br/>
&nbsp; &nbsp; &nbsp; &nbsp; if (failedOverheadMemoryTasks &gt; 0) {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stagesWithOverheadError = stagesWithOverheadError + 1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; }<br/>
&nbsp; &nbsp; &nbsp; &nbsp; severityOOM = <a href="#L106" title="heuristics/StagesWithFailedTasksHeuristic.scala:106">getStageSeverity</a>(failedOOMTasks, stageData.<a href="../fetcher/status/statusapiv1.scala.html#L111" title="fetcher/status/statusapiv1.scala:111">status</a>, severityOOM, <a href="../fetcher/status/statusapiv1.scala.html#L154" title="fetcher/status/statusapiv1.scala:154">numCompleteTasks</a>)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; severityOverhead = <a href="#L106" title="heuristics/StagesWithFailedTasksHeuristic.scala:106">getStageSeverity</a>(failedOverheadMemoryTasks, stageData.<a href="../fetcher/status/statusapiv1.scala.html#L111" title="fetcher/status/statusapiv1.scala:111">status</a>, severityOverhead, <a href="../fetcher/status/statusapiv1.scala.html#L154" title="fetcher/status/statusapiv1.scala:154">numCompleteTasks</a>)<br/>
&nbsp; &nbsp; &nbsp; })<br/>
&nbsp; &nbsp; &nbsp; (severityOOM, severityOverhead, stagesWithOOMError, stagesWithOverheadError)<br/>
&nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; if (data.executorSummaries == null) {<br/>
&nbsp; &nbsp; &nbsp; throw new Exception(&quot;Executor Summary is Null.&quot;)<br/>
&nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; /**<br/>
&nbsp; &nbsp;&nbsp; * returns the <a href="../utils/AggregatePerfValue.scala.html#L26" title="utils/AggregatePerfValue.scala:26">max</a> (severity of this <a href="../utils/spark/PerStageReport.scala.html#L26" title="utils/spark/PerStageReport.scala:26">stage</a>, present severity)<br/>
&nbsp; &nbsp;&nbsp; *<br/>
&nbsp; &nbsp;&nbsp; * note : this method is called for all the stages, in turn updating the <a href="../fetcher/status/statusapiv1.scala.html#L305" title="fetcher/status/statusapiv1.scala:305">value</a> of <a href="../utils/AggregatePerfValue.scala.html#L26" title="utils/AggregatePerfValue.scala:26">max</a> <a href="../utils/spark/PerStageReport.scala.html#L26" title="utils/spark/PerStageReport.scala:26">stage</a> severity if required.<br/>
&nbsp; &nbsp;&nbsp; *<br/>
&nbsp; &nbsp;&nbsp; * @param <a href="../fetcher/status/statusapiv1.scala.html#L116" title="fetcher/status/statusapiv1.scala:116">numFailedTasks</a><br/>
&nbsp; &nbsp;&nbsp; * @param stageStatus<br/>
&nbsp; &nbsp;&nbsp; * @param severityStage : <a href="../utils/AggregatePerfValue.scala.html#L26" title="utils/AggregatePerfValue.scala:26">max</a> severity of all the stages we have encountered till now.<br/>
&nbsp; &nbsp;&nbsp; * @param <a href="../fetcher/status/statusapiv1.scala.html#L154" title="fetcher/status/statusapiv1.scala:154">numCompleteTasks</a><br/>
&nbsp; &nbsp;&nbsp; * @return<br/>
&nbsp; &nbsp;&nbsp; */<br/>
<a id="L106">&#x200c;</a>&nbsp; &nbsp; private def <span class="linkable">getStageSeverity</span>(<a href="../fetcher/status/statusapiv1.scala.html#L116" title="fetcher/status/statusapiv1.scala:116">numFailedTasks</a>: Int, stageStatus: StageStatus, severityStage: Severity, <a href="../fetcher/status/statusapiv1.scala.html#L154" title="fetcher/status/statusapiv1.scala:154">numCompleteTasks</a>: Int): Severity = {<br/>
&nbsp; &nbsp; &nbsp; var severityTemp: Severity = Severity.NONE<br/>
&nbsp; &nbsp; &nbsp; if (<a href="../fetcher/status/statusapiv1.scala.html#L154" title="fetcher/status/statusapiv1.scala:154">numCompleteTasks</a> == 0) {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; return severityStage<br/>
&nbsp; &nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; &nbsp; if (<a href="../fetcher/status/statusapiv1.scala.html#L116" title="fetcher/status/statusapiv1.scala:116">numFailedTasks</a> != 0 &amp;&amp; stageStatus != StageStatus.FAILED) {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; if (<a href="../fetcher/status/statusapiv1.scala.html#L116" title="fetcher/status/statusapiv1.scala:116">numFailedTasks</a>.toDouble / <a href="../fetcher/status/statusapiv1.scala.html#L154" title="fetcher/status/statusapiv1.scala:154">numCompleteTasks</a>.toDouble &lt; ratioThreshold / 100.toDouble) {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; severityTemp = Severity.MODERATE<br/>
&nbsp; &nbsp; &nbsp; &nbsp; } else {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; severityTemp = Severity.SEVERE<br/>
&nbsp; &nbsp; &nbsp; &nbsp; }<br/>
&nbsp; &nbsp; &nbsp; } else if (<a href="../fetcher/status/statusapiv1.scala.html#L116" title="fetcher/status/statusapiv1.scala:116">numFailedTasks</a> != 0 &amp;&amp; stageStatus == StageStatus.FAILED &amp;&amp; <a href="../fetcher/status/statusapiv1.scala.html#L116" title="fetcher/status/statusapiv1.scala:116">numFailedTasks</a> / <a href="../fetcher/status/statusapiv1.scala.html#L154" title="fetcher/status/statusapiv1.scala:154">numCompleteTasks</a> &gt; 0) {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; severityTemp = Severity.CRITICAL<br/>
&nbsp; &nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; &nbsp; Severity.<a href="../utils/AggregatePerfValue.scala.html#L26" title="utils/AggregatePerfValue.scala:26">max</a>(severityTemp, severityStage)<br/>
&nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; /**<br/>
&nbsp; &nbsp;&nbsp; * checks whether the error message contains the corresponding error<br/>
&nbsp; &nbsp;&nbsp; *<br/>
&nbsp; &nbsp;&nbsp; * @param <a href="../fetcher/status/statusapiv1.scala.html#L201" title="fetcher/status/statusapiv1.scala:201">errorMessage</a> : the entire error message<br/>
&nbsp; &nbsp;&nbsp; * @param whichError&nbsp;&nbsp; : the error we want to search the error message with<br/>
&nbsp; &nbsp;&nbsp; * @param noTasks&nbsp; &nbsp; &nbsp; : number of <a href="../fetcher/status/statusapiv1.scala.html#L180" title="fetcher/status/statusapiv1.scala:180">tasks</a> having that error<br/>
&nbsp; &nbsp;&nbsp; * @return : returning the number of <a href="../fetcher/status/statusapiv1.scala.html#L180" title="fetcher/status/statusapiv1.scala:180">tasks</a> having the error.<br/>
&nbsp; &nbsp;&nbsp; */<br/>
<a id="L133">&#x200c;</a>&nbsp; &nbsp; private def <span class="linkable">hasError</span>(<a href="../fetcher/status/statusapiv1.scala.html#L201" title="fetcher/status/statusapiv1.scala:201">errorMessage</a>: String, whichError: String, noTasks: Int): Int = {<br/>
&nbsp; &nbsp; &nbsp; if (<a href="../fetcher/status/statusapiv1.scala.html#L201" title="fetcher/status/statusapiv1.scala:201">errorMessage</a>.contains(whichError))<br/>
&nbsp; &nbsp; &nbsp; &nbsp; return noTasks + 1<br/>
&nbsp; &nbsp; &nbsp; return noTasks<br/>
&nbsp; &nbsp; }<br/>
<br/>
&nbsp; }<br/>
<br/>
}</code>

 </body>
</html>
